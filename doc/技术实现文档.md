# 用户认证系统技术实现文档

## 一、项目概述

本项目实现了一个完整的用户认证系统，包括登录、注册和密码重置功能，采用前后端分离架构，后端使用Flask框架，前端使用Vue 3框架。

## 二、数据库设计

### 2.1 用户表（users）

| 字段名 | 数据类型 | 约束 | 描述 |
| --- | --- | --- | --- |
| id | VARCHAR(36) | PRIMARY KEY | 用户唯一标识 |
| user_id | VARCHAR(36) | UNIQUE | 前端localStorage中的user_id |
| email | VARCHAR(120) | UNIQUE, NOT NULL | 邮箱作为用户唯一标识 |
| password | VARCHAR(255) | NOT NULL | 加密后的密码 |
| email_verified | BOOLEAN | DEFAULT FALSE | 邮箱是否已验证 |
| verification_code | VARCHAR(6) | NULL | 邮箱验证码 |
| verification_code_expiry | DATETIME | NULL | 验证码过期时间 |
| reset_password_token | VARCHAR(100) | NULL | 密码重置令牌 |
| reset_password_expiry | DATETIME | NULL | 密码重置令牌过期时间 |
| login_attempts | INT | DEFAULT 0 | 登录尝试次数 |
| locked_until | DATETIME | NULL | 账号锁定时间 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 2.2 数据库表变更

- 修改了原有的User模型，添加了邮箱、密码等字段
- 调整了user_id字段为可选，不再作为必填项
- 添加了邮箱验证相关字段
- 添加了密码重置相关字段
- 添加了防暴力破解相关字段

## 三、后端实现

### 3.1 技术栈

- Flask 2.3.2
- Flask-SQLAlchemy 3.1.1
- Flask-CORS 4.0.0
- Flask-Mail 0.9.1
- PyJWT 2.8.0
- bcrypt 4.2.0
- email-validator 2.2.0

### 3.2 核心功能实现

#### 3.2.1 注册功能

- 邮箱格式验证
- 邮箱唯一性校验
- 验证码生成与发送
- 验证码有效期管理（15分钟）
- 密码加密存储（使用bcrypt）
- JWT令牌生成

#### 3.2.2 登录功能

- 邮箱密码验证
- 登录尝试次数限制
- 账号锁定机制（5次失败尝试后锁定5分钟）
- 记住我功能支持
- JWT令牌生成

#### 3.2.3 密码重置功能

- 重置链接生成与发送
- 重置链接有效期管理（24小时）
- 密码更新功能

### 3.3 API端点

| 端点 | 方法 | 功能描述 |
| --- | --- | --- |
| /api/auth/send-verification-code | POST | 发送邮箱验证码 |
| /api/auth/register | POST | 用户注册 |
| /api/auth/login | POST | 用户登录 |
| /api/auth/refresh | POST | 刷新JWT令牌 |
| /api/auth/request-reset-password | POST | 请求重置密码 |
| /api/auth/reset-password | POST | 重置密码 |

### 3.4 安全机制

- 密码使用bcrypt加密存储
- JWT令牌认证
- 防暴力破解机制
- HTTPS传输（建议生产环境使用）

## 四、前端实现

### 4.1 技术栈

- Vue 3
- Vue Router 4
- Axios

### 4.2 核心功能实现

#### 4.2.1 登录页面

- 邮箱密码登录表单
- 表单实时验证
- 记住我选项
- 忘记密码链接
- 注册链接

#### 4.2.2 注册页面

- 邮箱验证码注册表单
- 邮箱格式验证
- 密码强度提示
- 验证码发送与倒计时功能（15分钟）
- 实时表单验证

#### 4.2.3 密码重置功能

- 密码重置请求页面
- 重置密码页面
- 表单验证

### 4.3 路由配置

| 路由 | 组件 | 功能描述 |
| --- | --- | --- |
| /login | LoginView | 登录页面 |
| /register | RegisterView | 注册页面 |
| /forgot-password | ForgotPasswordView | 密码重置请求页面 |
| /reset-password | ResetPasswordView | 密码重置页面 |

### 4.4 前端验证规则

- 邮箱格式验证
- 密码强度验证（至少8位，包含大小写字母、数字和特殊符号）
- 必填项检查
- 实时反馈

## 五、系统流程

### 5.1 注册流程

1. 用户访问注册页面
2. 输入邮箱、密码和验证码
3. 前端验证表单数据
4. 点击"获取验证码"按钮，系统发送验证码到用户邮箱
5. 用户输入验证码
6. 点击"注册"按钮，系统验证验证码并创建用户
7. 注册成功后，系统生成JWT令牌并跳转到首页

### 5.2 登录流程

1. 用户访问登录页面
2. 输入邮箱和密码
3. 前端验证表单数据
4. 点击"登录"按钮，系统验证用户凭据
5. 登录成功后，系统生成JWT令牌并跳转到首页
6. 登录失败时，系统记录失败次数，超过限制则锁定账号

### 5.3 密码重置流程

1. 用户访问忘记密码页面
2. 输入注册邮箱
3. 点击"发送重置链接"按钮，系统发送重置链接到用户邮箱
4. 用户点击邮件中的重置链接
5. 跳转到密码重置页面，输入新密码
6. 点击"重置密码"按钮，系统更新密码
7. 密码重置成功后，系统提示用户并跳转到登录页面

## 六、测试建议

### 6.1 功能测试

- 注册流程测试
- 登录流程测试（包括记住我功能）
- 密码重置流程测试
- 验证码有效期测试
- 登录尝试次数限制测试

### 6.2 安全性测试

- 密码加密存储测试
- JWT令牌安全性测试
- 防暴力破解测试

### 6.3 性能测试

- 并发登录测试
- 验证码发送性能测试

## 七、部署建议

### 7.1 环境配置

- 设置环境变量JWT_SECRET_KEY，使用强随机字符串
- 配置MAIL_SERVER、MAIL_PORT、MAIL_USERNAME和MAIL_PASSWORD
- 设置HTTPS证书，确保所有请求通过HTTPS传输

### 7.2 生产环境优化

- 配置数据库连接池
- 使用Redis存储验证码和重置链接，提高性能
- 配置日志记录，便于监控和调试
- 设置定期清理过期验证码和重置链接的任务

## 八、后续优化建议

1. 添加社交登录功能（微信、QQ、GitHub等）
2. 实现双因素认证
3. 添加用户头像上传功能
4. 实现用户信息管理功能
5. 添加登录日志记录
6. 实现更细粒度的权限控制

## 九、文件结构

```
backend/
├── app/
│   ├── __init__.py          # 应用初始化
│   ├── models.py            # 数据库模型
│   ├── routes/
│   │   ├── __init__.py      # 路由初始化
│   │   └── auth.py          # 认证相关API
│   └── utils/
│       └── jwt_utils.py     # JWT工具类
├── config.py                # 配置文件
├── requirements.txt         # 依赖列表
└── run.py                   # 应用入口

src/
├── views/
│   ├── LoginView.vue        # 登录页面
│   ├── RegisterView.vue     # 注册页面
│   ├── ForgotPasswordView.vue # 密码重置请求页面
│   └── ResetPasswordView.vue # 密码重置页面
├── router/
│   └── index.js             # 路由配置
└── utils/
    └── api.js               # API客户端
```

## 十、总结

本用户认证系统实现了完整的注册、登录和密码重置功能，具有良好的安全性和用户体验。系统采用了前后端分离架构，便于维护和扩展。通过使用bcrypt加密存储密码、JWT令牌认证和防暴力破解机制，确保了系统的安全性。前端实现了实时表单验证、密码强度提示和验证码倒计时功能，提供了良好的用户体验。